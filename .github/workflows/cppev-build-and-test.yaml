# å«ä¹‰ï¼šå®šä¹‰è¿™ä¸ªå·¥ä½œæµçš„åç§°ã€‚å®ƒä¼šæ˜¾ç¤ºåœ¨ GitHub ä»“åº“çš„ "Actions" æ ‡ç­¾é¡µåˆ—è¡¨ä¸­ã€‚
name: Cppev CI 
# å®šä¹‰æ¯ä¸€æ¬¡å…·ä½“è¿è¡Œï¼ˆRunï¼‰çš„åç§°ã€‚å½“ä½ æŽ¨é€ä»£ç è§¦å‘ä¸€æ¬¡æž„å»ºæ—¶ï¼Œè¿™æ¬¡æž„å»ºåœ¨åˆ—è¡¨é‡Œä¼šæ˜¾ç¤ºè¿™ä¸ªåå­—ã€‚ðŸš€ æ˜¯è£…é¥°ç”¨çš„ Emojiï¼Œæ–¹ä¾¿è§†è§‰è¯†åˆ«ã€‚
run-name: Cppev CI ðŸš€
# å®šä¹‰è§¦å‘æ¡ä»¶ã€‚[push] è¡¨ç¤ºåªè¦æœ‰ä»£ç  æŽ¨é€ (push) åˆ°ä»“åº“çš„ä»»æ„åˆ†æ”¯ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘è¿™ä¸ªå·¥ä½œæµã€‚
on: [push]
# jobs å¼€å§‹å®šä¹‰ä»»åŠ¡åˆ—è¡¨ã€‚bazel-build-and-test æ˜¯è¿™ä¸ªä»»åŠ¡çš„å”¯ä¸€ IDã€‚
jobs:
  # å®ƒå‘Šè¯‰ GitHubï¼šâ€œè¯·å¸®æˆ‘è£‚å˜å‡ºå¤šä¸ªå­ä»»åŠ¡â€ã€‚
  # è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå˜é‡ osï¼ŒåŒ…å«ä¸¤ä¸ªå€¼ã€‚GitHub ä¼šè‡ªåŠ¨è¿è¡Œä¸¤æ¬¡è¿™ä¸ªä»»åŠ¡ï¼šä¸€æ¬¡åœ¨ Ubuntu ä¸Šï¼Œä¸€æ¬¡åœ¨ macOS ä¸Šã€‚è¿™ç”¨æ¥æµ‹è¯•è·¨å¹³å°å…¼å®¹æ€§ã€‚
  bazel-build-and-test:
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    runs-on: ${{ matrix.os }}
    # å¼€å§‹å®šä¹‰è¿™ä¸ªä»»åŠ¡å…·ä½“è¦æ‰§è¡Œçš„æ­¥éª¤åºåˆ—ã€‚
    steps:
    # æŠŠä½ çš„ GitHub ä»“åº“ä»£ç ä¸‹è½½ï¼ˆæ‹‰å–ï¼‰åˆ°å½“å‰çš„è¿è¡ŒçŽ¯å¢ƒä¸­ï¼Œå¦åˆ™åŽé¢çš„å‘½ä»¤æ²¡ä»£ç å¯ç¼–è¯‘ã€‚
    - uses: actions/checkout@v4
    # é…ç½® Go è¯­è¨€çŽ¯å¢ƒ
    # Bazel çš„å¯åŠ¨å™¨ï¼Œé€šå¸¸æ˜¯ç”¨ Go å†™çš„
    - uses: actions/setup-go@v5
      with:
        go-version: '>=1.20.0'
    # é…ç½® Python çŽ¯å¢ƒ
    # Bazel æž„å»ºç³»ç»Ÿé€šå¸¸ä¾èµ– Python æ¥è¿è¡Œä¸€äº›è„šæœ¬æˆ–æµ‹è¯•
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # è¿è¡Œ Shell å‘½ä»¤ã€‚ä½¿ç”¨ Go å‘½ä»¤ä»Ž GitHub å®‰è£…æœ€æ–°ç‰ˆçš„ bazelisk å·¥å…·
    - run: go install github.com/bazelbuild/bazelisk@latest
    # åˆ›å»ºä¸€ä¸ªè½¯é“¾æŽ¥
    # æŠŠåˆšå®‰è£…çš„ bazelisk é“¾æŽ¥ä¸ºå‘½ä»¤ bazelã€‚
    # è¿™æ ·å½“ä½ åœ¨åŽé¢è¾“å…¥ bazel æ—¶ï¼Œå®žé™…ä¸Šè¿è¡Œçš„æ˜¯ bazeliskã€‚Bazelisk ä¼šè‡ªåŠ¨å¸®ä½ ä¸‹è½½å¹¶ç®¡ç†é€‚åˆé¡¹ç›®çš„ Bazel ç‰ˆæœ¬
    - run: ln $(go env GOPATH)/bin/bazelisk $(go env GOPATH)/bin/bazel

    # //...ï¼šæ˜¯ Bazel çš„é€šé…ç¬¦ï¼Œæ„æ€æ˜¯â€œé€’å½’ç¼–è¯‘æœ¬é¡¹ç›®ä¸‹çš„æ‰€æœ‰ç›®æ ‡ï¼ˆTargetï¼‰
    - run: bazel build //...
    # è¿è¡Œé¡¹ç›®ä¸­å®šä¹‰çš„æ‰€æœ‰å•å…ƒæµ‹è¯•ã€‚å¦‚æžœæµ‹è¯•å¤±è´¥ï¼ŒCI å°±ä¼šæŠ¥é”™å˜çº¢
    - run: bazel test //...

  cmake-build:
    # å®šä¹‰ç¬¬äºŒä¸ªä»»åŠ¡çš„ IDã€‚è¿™ä¸¤ä¸ªä»»åŠ¡ï¼ˆBazel å’Œ CMakeï¼‰é»˜è®¤æ˜¯å¹¶è¡Œè¿è¡Œçš„
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest ]
        cmake_build_type: [ RelWithDebInfo ]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT";

    - name: Configure CMake
      run: >
        cmake -B ${{ steps.strings.outputs.build-output-dir }}
        -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }}
        -S ${{ github.workspace }}

    - name: Build
      run: |
        cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.cmake_build_type }}
